name: Build, Test and Release

on:
    pull_request_target:
        types: [opened, synchronize, reopened]
        branches: [ master ]

jobs:
    build-test-release:
        name: Build artifacts
        runs-on: ubuntu-latest

        steps:
            - name: Checkout master branch
              uses: actions/checkout@v3
            
            - name: Checkout PR branch
              uses: actions/checkout@v3
              with:
                ref: ${{ github.event.pull_request.head.ref }}
                repository: ${{ github.event.pull_request.head.repo.full_name }}
                path: "test-github-actions"

            - name: Setup Go
              uses: actions/setup-go@v4
              with:
                go-version-file: go.mod
                
            - name: Ensure Modules
              working-directory: ./test-github-actions
              run: make tidy

            - name: Ensure Formatting
              working-directory: ./test-github-actions
              run: make fmt

            - name: Run Linters
              working-directory: ./test-github-actions
              run: make lint

            - name: Build Binary
              working-directory: ./test-github-actions
              run: make bin

            ## Run Tests ##




            - name: Check if automerge ## Simulate "release-checker" script
              working-directory: ./test-github-actions
              id: check_automerge
              run: |
                  AUTOMERGE=$(out/test-github-actions automerge)
                  echo $AUTOMERGE >> $GITHUB_OUTPUT

            - name: Show if automerge
              working-directory: ./test-github-actions
              id: show_automerge
              run: echo ${{ steps.check_automerge.outputs.automerge.automerge }}

            - name: Approve PR
              id: approve_pr
              if: ${{ steps.check_automerge.outputs.automerge == 'true'}}
              uses: hmarr/auto-approve-action@v2
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Merge PR
              id: merge_pr
              if: ${{ steps.check_automerge.outputs.automerge == 'true'}}
              uses: pascalgn/automerge-action@v0.13.1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                MERGE_METHOD: squash
                MERGE_LABELS: ""

